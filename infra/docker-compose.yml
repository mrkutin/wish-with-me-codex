services:
  mongo:
    image: mongo:7
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: wish
    volumes:
      - mongo_data:/data/db

  redis:
    image: redis:7
    restart: unless-stopped
    ports:
      - "6379:6379"

  rabbitmq:
    image: rabbitmq:3.12-management
    restart: unless-stopped
    ports:
      - "5672:5672"
      - "15672:15672"

  core-api:
    build:
      context: ../services/core-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      MONGO_URI: mongodb://mongo:27017/wish
      REDIS_URL: redis://redis:6379/0
      RABBITMQ_URL: amqp://rabbitmq:5672/
      JWT_SECRET: dev-secret
      JWT_ISSUER: wish-with-me
      ACCESS_TOKEN_TTL_DAYS: "7"
      REFRESH_TOKEN_TTL_DAYS: "7"
    depends_on:
      - mongo
      - redis
      - rabbitmq

  item-resolver:
    build:
      context: ../services/item-resolver
    restart: unless-stopped
    ports:
      - "8001:8001"
    dns:
      - "1.1.1.1"
      - "8.8.8.8"
    environment:
      REDIS_URL: redis://redis:6379/0
      RESOLVER_CACHE_TTL_DAYS: "7"
      RATE_LIMIT_PER_MINUTE: "30"
      RESOLVER_TIMEOUT_SECONDS: "180"
      SCREENSHOT_MAX_BYTES: "300000"
      SCREENSHOT_MAX_WIDTH: "1280"
      RENDER_MODE: "playwright"
      LLM_MODE: "live"
      BROWSER_CHANNEL: "chromium"
      HEADLESS: "true"
      MAX_CONCURRENCY: "2"
      STORAGE_STATE_DIR: "storage_state"
      SSRF_ALLOWLIST_HOSTS: ""
      OPENAI_API_KEY: "${OPENAI_API_KEY}"
      OPENAI_BASE_URL: "https://api.openai.com/v1"
      OPENAI_MODEL: "gpt-4o-mini"
      OPENAI_TIMEOUT_SECONDS: "20"
      OPENAI_MAX_INPUT_CHARS: "120000"
      OPENAI_MAX_OUTPUT_TOKENS: "800"
      CAPTURE_WAIT_UNTIL: "domcontentloaded"
      CAPTURE_TIMEOUT_MS: "180000"
      CAPTURE_SETTLE_MS: "2000"
      CAPTURE_MAX_EXTRA_WAIT_MS: "90000"
      CAPTURE_NETWORK_QUIET_MS: "1200"
      CAPTURE_DOM_SAMPLE_INTERVAL_MS: "500"
      CAPTURE_DOM_STABLE_SAMPLES: "3"
      CAPTURE_CHALLENGE_EXTRA_WAIT_MS: "240000"
      DEBUG_CAPTURE_DIR: "/app/.debug_captures"
      PROXY_HOST: "pool.proxy.market"
      PROXY_PORT: "10005"
      PROXY_USERNAME: "${PROXY_USERNAME:-}"
      PROXY_PASSWORD: "${PROXY_PASSWORD:-}"
    depends_on:
      - redis

volumes:
  mongo_data:
