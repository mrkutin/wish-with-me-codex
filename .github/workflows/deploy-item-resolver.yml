name: Deploy item-resolver

on:
  push:
    branches:
      - main
    paths:
      - 'services/item-resolver/**'
  workflow_dispatch:

env:
  SERVER_HOST: 158.69.203.3
  SERVER_USER: ubuntu
  DEPLOY_PATH: /home/ubuntu/wish-with-me-codex/services/item-resolver

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Create env file content
        run: |
          cat > /tmp/env_content << EOF
          RU_BEARER_TOKEN=${{ secrets.RU_BEARER_TOKEN }}
          BROWSER_CHANNEL=${{ secrets.BROWSER_CHANNEL }}
          HEADLESS=${{ secrets.HEADLESS }}
          MAX_CONCURRENCY=${{ secrets.MAX_CONCURRENCY }}
          SSRF_ALLOWLIST_HOSTS=${{ secrets.SSRF_ALLOWLIST_HOSTS }}
          PROXY_SERVER=${{ secrets.PROXY_SERVER }}
          PROXY_USERNAME=${{ secrets.PROXY_USERNAME }}
          PROXY_PASSWORD=${{ secrets.PROXY_PASSWORD }}
          PROXY_BYPASS=${{ secrets.PROXY_BYPASS }}
          PROXY_IGNORE_CERT_ERRORS=${{ secrets.PROXY_IGNORE_CERT_ERRORS }}
          RANDOM_UA=${{ secrets.RANDOM_UA }}
          LLM_MODE=${{ secrets.LLM_MODE }}
          LLM_BASE_URL=${{ secrets.LLM_BASE_URL }}
          LLM_API_KEY=${{ secrets.LLM_API_KEY }}
          LLM_MODEL=${{ secrets.LLM_MODEL }}
          LLM_TIMEOUT_S=${{ secrets.LLM_TIMEOUT_S }}
          LLM_MAX_CHARS=${{ secrets.LLM_MAX_CHARS }}
          EOF

      - name: Copy env file to server
        run: |
          scp /tmp/env_content ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/.env

      - name: Deploy to server
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            set -e
            cd /home/ubuntu/wish-with-me-codex/services/item-resolver

            echo "Pulling latest code..."
            git pull origin main

            echo "Building and restarting container..."
            docker compose down
            docker compose up -d --build

            echo "Waiting for service to start..."
            sleep 15

            echo "Checking health endpoint..."
            curl -sf http://localhost:8000/healthz || (echo "Health check failed!" && exit 1)

            echo "Deployment complete!"
          ENDSSH

      - name: Verify deployment
        run: |
          echo "Verifying service is accessible..."
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "curl -sf http://localhost:8000/healthz && echo 'Service is healthy!'"
